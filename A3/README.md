# COVID19 Paper Code

Scripts are divided into the sections described below. These scripts may require input data stored in the input folder (default to input.data) and output files generated by other scripts in the package (default to a folder named output).

Please note the following in order to reproduce the figures shown in the markdown reports:
- unzip any compressed files in the input folder
- for the Rmd file to compile, the project directory needs to be chosen as the knit directory
- use RNGkind(sample.kind = "Rounding") for backward compatibility as the algorithm used for the random number generator has changed since R 3.6

### Requirements

Major packages:
- R 3.5.2 and 3.6.3
- plsRglm_1.2.5
- lme4_1.1-23
- huge_1.3.4.1
- limma_3.42.2
- GSVA_1.30.0
- parallel_3.5.2

See scripts for other packages used.

### Overview

To provide a timeline of the PBMC sampling and treatments for 33 COVID-19 patients that have CITE-seq data generated

#### Script: Patient.and.sample.overview.Rmd

Input: Metadata file (input/covid19.metadata.paper1.RData)

Output: Figures 1A and S1A


### DSM

To calculate a quantitative severity score for each patient using clinical and circulating protein measurements closest to the samples of interest. We first calculated scores for 30 CITE-seq patients (excluding those whose initial samples are >= 30 days since symptom onset), then as validation indepedently for an additional 64 patients 

#### Script: citeseq.patient.dsm.Rmd

Input: Metadata file (input/covid19.metadata.paper1.RData), sample WHO severity scores (input/pbmc.samples.csv)

Output: Figures 1C, 1D, S1B, citeseq.patient.end.points.RDS

#### Script: brescia.dsm.validation.Rmd

Input: Metadata file (input/covid19.metadata.paper1.RData)

Output: Figure 1E, S1C


### Severity Network

To create the severity network that shows cell type-specific pathways directly correlated with disease severity

#### Script: severity.network.Rmd

Input: DSM scores (citeseq.patient.end.points.RDS from citeseq.patient.dsm.Rmd), GSEA results (input/gene.set.scores.and.gsea.csv), gene set module scores (input/PC1_PC1_module_score_gsva_filtered_samples_genes.rds), selected gene set list (input/pathway_summary.csv)

Output: Table S6, Figure 4A


### Cytokine Geneset Correlation

To calculate correlation between 63 circulating proteins, DSM, and selected gene sets. In addition, check whether correlations may be driven by steroid use. 

#### Script: citeseq.T0.cytokine.pathway.corr.Rmd

Input: Metadata file (input/covid19.metadata.paper1.RData), DSM scores (citeseq.patient.end.points.RDS from citeseq.patient.dsm.Rmd), GSEA results (input/gene.set.scores.and.gsea.csv), gene set module scores (input/PC1_PC1_module_score_gsva_filtered_samples_genes.rds), selected gene set list (input/pathway_summary.csv), steroid usage (input/pbmc.samples.csv), glucose response gene set module scores (input/glucResponseGenesforModel_module_score_gsva_filtered_samples_genes.rds), TSC22D3 mRNA expression in NK CD16hi cells (input/NK_CD16hi_TSC22D3.exp.RDS)

Output: Figure S4A,S4B,S5B,S5C, Table OS1


### Critical Juncture

To profile ciriculating protein abundance, especially for the critical juncture at 17 to 23 days since symptom onset, for both DSM-high vs. DSM-low and deceased vs. recovered patients. Additionally, validate critical juncture findings in an independent cohort (https://www.nature.com/articles/s41586-020-2588-y). PLS-based classifiers are built with cytokine abundance as predictors to predict patient outcome. 

#### Script: dsm.high.v.low.cytokine.Rmd

Input: Metadata file (input/covid19.metadata.paper1.RData), DSM scores (citeseq.patient.end.points.RDS from citeseq.patient.dsm.Rmd)

Output: Figure 6F, Table S7, test results (dsm.high.v.low.cytokine.test.results.RData)

#### Script: deceased.v.recovered.cytokine.Rmd

Input: Metadata file (input/covid19.metadata.paper1.RData), dsm-high vs. -low test results (dsm.high.v.low.cytokine.test.results.RData from dsm.high.v.low.cytokine.Rmd)

Output: Figures 7B,7D,7E,S7C, Table S7, test results (deceased.v.recovered.cytokine.test.results.RData)

#### Script: deceased.v.recovered.prediction.Rmd

Input: Metadata file (input/covid19.metadata.paper1.RData)

Output: Figure 7C

#### Script: deceased.v.recovered.cytokine.permutation.Rmd

Input: Metadata file (input/covid19.metadata.paper1.RData)

Output: Table S8 (permutation p-values)

#### Script: cytokine.critical.juncture.validation.Rmd

Input: Metadata file (input/covid19.metadata.paper1.RData), deceased v. recovered test results (deceased.v.recovered.cytokine.test.results.RData from deceased.v.recovered.cytokine.Rmd), independent cohort data (input/external_studies/Yale_misfiring/yale.data.csv)

Output: Figure S7D


